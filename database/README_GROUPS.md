# Groups Management System

Este documento descreve o sistema de gerenciamento de grupos hier√°rquicos para a aplica√ß√£o Ritho.

## Estrutura do Banco de Dados

A tabela `groups` tem a seguinte estrutura:

```sql
CREATE TABLE groups (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name text NOT NULL,
    parent_id bigint REFERENCES groups(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
```

## Funcionalidades

### 1. Camada de Banco de Dados
- **Tabela**: `groups` com refer√™ncia hier√°rquica (parent_id)
- **Triggers**: Atualiza√ß√£o autom√°tica de `updated_at`
- **Constraints**: Nomes √∫nicos por n√≠vel hier√°rquico
- **Preven√ß√£o**: Refer√™ncias circulares atrav√©s de triggers
- **Cascata**: Exclus√£o em cascata de subgrupos
- **√çndices**: Otimizados para consultas hier√°rquicas

### 2. Servi√ßos Backend (`lib/supabase.ts`)
- **groupsService**: Opera√ß√µes CRUD completas
  - `getAll()`: Buscar todos os grupos
  - `getRootGroups()`: Buscar apenas grupos raiz
  - `getSubgroups(parentId)`: Buscar subgrupos de um pai
  - `getById(id)`: Buscar grupo espec√≠fico
  - `create(group)`: Criar novo grupo
  - `update(id, updates)`: Atualizar grupo
  - `delete(id)`: Deletar grupo (com valida√ß√£o de subgrupos)
  - `checkNameExists(name, parentId?, excludeId?)`: Verificar duplicatas no mesmo n√≠vel
  - `getBreadcrumb(id)`: Obter caminho hier√°rquico
  - `getHierarchy()`: Obter estrutura hier√°rquica completa

### 3. Interface Frontend (`app/grupos.tsx`)
- **Visualiza√ß√£o Hier√°rquica**: Exibi√ß√£o em √°rvore com identa√ß√£o
- **Visualiza√ß√£o Plana**: Lista simples de todos os grupos
- **Formul√°rio**: Cria√ß√£o/edi√ß√£o com sele√ß√£o de grupo pai
- **Valida√ß√µes**: Preven√ß√£o de duplicatas e refer√™ncias circulares
- **A√ß√µes**: Editar, excluir com confirma√ß√£o
- **Altern√¢ncia**: Bot√£o para alternar entre visualiza√ß√µes
- **Suporte**: Modo escuro/claro

### 4. Navega√ß√£o
- Adicionado ao stack principal em `app/_layout.tsx`
- Inclu√≠do no menu da home em `app/(tabs)/index.tsx`
- Acess√≠vel via menu lateral

## Hierarquia de Grupos

### Estrutura
- **Grupo Raiz**: `parent_id = NULL`
- **Subgrupo**: `parent_id = ID do grupo pai`
- **Profundidade**: Ilimitada (mas recomendado m√°ximo 3 n√≠veis)

### Exemplo de Hierarquia
```
Roupas Masculinas (raiz)
‚îú‚îÄ‚îÄ Camisas (subgrupo)
‚îÇ   ‚îú‚îÄ‚îÄ Camisas Sociais (sub-subgrupo)
‚îÇ   ‚îî‚îÄ‚îÄ Camisas Casuais (sub-subgrupo)
‚îî‚îÄ‚îÄ Cal√ßas (subgrupo)
    ‚îú‚îÄ‚îÄ Cal√ßas Sociais (sub-subgrupo)
    ‚îî‚îÄ‚îÄ Cal√ßas Jeans (sub-subgrupo)

Roupas Femininas (raiz)
‚îú‚îÄ‚îÄ Vestidos (subgrupo)
‚îî‚îÄ‚îÄ Saias (subgrupo)
```

## Valida√ß√µes e Regras

### 1. Valida√ß√µes de Nome
- Nomes √∫nicos dentro do mesmo n√≠vel hier√°rquico
- Dois grupos podem ter o mesmo nome se estiverem em n√≠veis diferentes
- Trimming autom√°tico de espa√ßos

### 2. Valida√ß√µes de Hierarquia
- Preven√ß√£o de refer√™ncias circulares
- Grupo n√£o pode ser pai de si mesmo
- Verifica√ß√£o autom√°tica de loops na hierarquia

### 3. Regras de Exclus√£o
- Grupos com subgrupos n√£o podem ser exclu√≠dos diretamente
- Exclus√£o em cascata quando for√ßada
- Confirma√ß√£o obrigat√≥ria para exclus√µes

## Uso da Interface

### Visualiza√ß√£o Hier√°rquica
1. **Navegar**: Grupos s√£o exibidos em √°rvore com identa√ß√£o
2. **Identificar**: √çcones diferentes para grupos raiz e subgrupos
3. **Expandir**: Subgrupos aparecem abaixo do grupo pai

### Visualiza√ß√£o Plana
1. **Listar**: Todos os grupos em lista simples
2. **Identificar**: Indica√ß√£o visual de "Grupo Raiz" ou "Subgrupo"
3. **Navegar**: Acesso direto a qualquer grupo

### Cria√ß√£o de Grupos
1. **Clique**: Bot√£o "+" no header
2. **Preencha**: Nome do grupo
3. **Selecione**: Grupo pai (opcional - deixe vazio para grupo raiz)
4. **Salve**: Bot√£o "Salvar"

### Edi√ß√£o de Grupos
1. **Clique**: √çcone de edi√ß√£o no grupo
2. **Modifique**: Nome e/ou grupo pai
3. **Salve**: Altera√ß√µes

### Exclus√£o de Grupos
1. **Clique**: √çcone de exclus√£o
2. **Confirme**: A√ß√£o na modal
3. **Aten√ß√£o**: Subgrupos impedem exclus√£o

## Configura√ß√£o do Banco

### Executar Script
```bash
database/create_groups_table.sql
```

### Verificar Instala√ß√£o
```sql
SELECT * FROM get_group_hierarchy();
```

### Dados de Exemplo
O script inclui dados de exemplo para demonstrar a funcionalidade.

## Solu√ß√£o de Problemas

### Bot√£o de Teste
- √çcone de bug (üêõ) no header executa testes diagn√≥sticos
- Verifica conectividade e opera√ß√µes b√°sicas
- Logs detalhados no console

### Logs de Debug
- Todos os servi√ßos incluem logging extensivo
- Rastreamento de opera√ß√µes do banco
- Identifica√ß√£o de erros espec√≠ficos

### Erros Comuns
1. **"Grupo n√£o encontrado"**: Verifique se a tabela existe
2. **"Refer√™ncia circular"**: N√£o tente criar loops na hierarquia
3. **"Nome duplicado"**: Nomes devem ser √∫nicos no mesmo n√≠vel
4. **"N√£o √© poss√≠vel excluir"**: Grupo possui subgrupos

## Integra√ß√£o com Outros M√≥dulos

### Produtos
- Grupos podem ser usados para categorizar produtos
- Refer√™ncia atrav√©s de `group_id` em outras tabelas

### Relat√≥rios
- Hierarquia √∫til para relat√≥rios por categoria
- Agrega√ß√µes por grupo e subgrupo

### Filtros
- Interface pode usar grupos para filtrar conte√∫do
- Busca hier√°rquica implementada

## Seguran√ßa

### RLS (Row Level Security)
- Habilitado para todos os usu√°rios autenticados
- Pol√≠ticas de acesso por fun√ß√£o

### Valida√ß√£o de Entrada
- Sanitiza√ß√£o de dados
- Preven√ß√£o de SQL injection
- Valida√ß√£o de tipos

### Auditoria
- Timestamps autom√°ticos
- Rastreamento de modifica√ß√µes
- Logs de sistema
